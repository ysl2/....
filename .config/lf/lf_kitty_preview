#!/usr/bin/env bash
# Ref:
# https://www.reddit.com/r/KittyTerminal/comments/132n4p5/any_lf_file_manager_users_how_to_preview_pdfs_as/
# https://github.com/rafi/.config/blob/master/lf/preview

# NOTE:
# For lf,
# `exit 1` means lf will not cache the preview result, and will run the cleaner script. Kitty need to exit 1 to solve the picture still remains after preview.
# `exit 0` means lf will cache the preview result and will acclerate the next time preview for same file. If not previewed by kitty, we can exit 0.

FILE="$(realpath "$1")"
W=$2
H=$3
X=$4
Y=$5

FILENAME=$(basename "$(echo "$FILE" | tr ' ' '_')")
# FILE_EXTENSION="${FILE##*.}"
# FILE_EXTENSION_LOWER="$(printf "%s" "${FILE_EXTENSION}" | tr '[:upper:]' '[:lower:]')"
MIMETYPE="$( file --dereference --brief --mime-type -- "$FILE" )"


function kitty_icat() {
    # NOTE:
    # Must exit 1, for lf running cleaner after the picture shows.
    # If exit 0, lf will not clean the picture after preview.

    # Ref: --transfer-mode
    # https://sw.kovidgoyal.net/kitty/kittens/icat/#cmdoption-kitty-kitten-icat-transfer-mode
    local retval=1
    if [[ -z "$TMUX" ]] && [[ "$TERM" == 'xterm-kitty' ]]; then
        kitty +kitten icat --silent --stdin no --transfer-mode stream --place "${W}x${H}@${X}x${Y}" "$1" < /dev/null > /dev/tty
        exit "$retval"
    fi
    local resolution=$(file "$1" | grep -oP '\d+\s*x\s*\d+')
    read -r width height <<< "$(echo "$resolution" | awk -Fx '{print $1, $2}')"
    # if [ "$width" -lt "$height" ]; then
    #     viu -sb -h "$H" "$1"
    # else
    #     viu -sb -w "$W" "$1"
    # fi
    if [ "$width" -lt "$height" ]; then
        img2sixel -h "$H"0 "$1"
    else
        img2sixel -w "$W"0 "$1"
    fi
    if [ $? -eq 0 ]; then
        exit "$retval"
    fi
    # chafa -f sixels image.png
    chafa -s "$W"x"$H" "$1" || \
        timg -E -g"$W"x"$H" "$1" || \
        catimg -r 2 -H "$H" "$1" || \
        imgcat --depth=256 --width "$W" "$1"
    exit "$retval"
}


function handle_extension() {
    case "$FILE" in
        *nii | *nii.gz)
            niicat "$FILE" -lb
            exit 0
            ;;
    esac
    # WARNING: Do not add any exit value here!
}


function handle_mime() {
    case "$MIMETYPE" in
        image/*)
            kitty_icat "$FILE"
            ;;
        *pdf)
            if [[ ! -f "/tmp/$FILENAME.png" ]]; then
                pdftoppm -f 1 -l 1 "$FILE" > "/tmp/$FILENAME.png"
            fi
            kitty_icat "/tmp/$FILENAME.png"
            ;;
        audio/*)
            if [[ ! -f "/tmp/$FILENAME.jpg" ]]; then
                ffmpeg -i "$FILE" -an -c:v copy "/tmp/$FILENAME.jpg"
            fi
            kitty_icat "/tmp/$FILENAME.png"
            ;;
        video/*)
            if [[ ! -f "/tmp/$FILENAME.jpg" ]]; then
                ffmpeg -i "$FILE" -vf "thumbnail" -frames:v 1 "/tmp/$FILENAME.jpg"
            fi
            kitty_icat "/tmp/$FILENAME.png"
            ;;
        *zip | *tar | *rar | *x-xz)
            # sudo apt install atool
            als "$FILE" | awk '{print $NF}'
            exit 0
            ;;
        *)
            cat "$FILE"
            exit 0
            ;;
    esac
    # WARNING: Do not add any exit value here!
}


function main() {
    handle_extension
    handle_mime
}


main "$@"
